---
- name: Install Nginx
  apt: pkg=nginx state=installed update_cache=true
  notify:
  - Start Nginx
  register: nginxinstalled

- name: Create Web Root
  when: nginxinstalled|success
  file: dest=/www/louisville.io/htdocs mode=2775 state=directory owner=www-data group=www-data
  notify:
  - Reload Nginx

- name: Add nginx vhost config
  when: nginxinstalled|success
  register: nginxconfig
  copy: src=louisville.io.conf dest=/etc/nginx/sites-available/louisville.io.conf owner=root group=root

- name: Activate the app
  when: nginxinstalled|success
  file: src=/etc/nginx/sites-available/louisville.io.conf dest=/etc/nginx/sites-enabled/louisville.io.conf state=link

- name: Disable Default Site
  when: nginxinstalled|success
  file: dest=/etc/nginx/sites-enabled/default state=absent

- name: Web Root Permissions
  when: nginxinstalled|success
  file: dest=/www/louisville.io mode=775 state=directory owner=www-data group=www-data recurse=yes
  notify:
    - Reload Nginx
- name: Install git
  apt: name=git
- name: Install nodejs
  apt: name=nodejs
- name: Install nodejs-legacy
  apt: name=nodejs-legacy
- name: Install npm
  apt: name=npm
- name: Download site
  git: repo=https://github.com/louisvilleio/loutechcal.git dest=/home/deploy/loutechcal
- name: Install dependencies
  npm: path=/home/deploy/loutechcal production=yes
- name: Build site
  command: npm run build chdir=/home/deploy/loutechcal
